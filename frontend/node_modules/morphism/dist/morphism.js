!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?exports.Morphism=r():e.Morphism=r()}(this,function(){return function(e){var r={};function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var o in e)t.d(n,o,function(r){return e[r]}.bind(null,o));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=0)}([function(e,r,t){"use strict";function n(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,n)}return t}function o(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}t.r(r);var i=Symbol.for("SchemaOptions");function a(e){return h(e)&&e.hasOwnProperty("fn")&&e.hasOwnProperty("path")}function c(e){return l(e)}function u(e){return Array.isArray(e)&&e.every(c)}var s,p=(e,r)=>e.reduce((e,t)=>(b(e,t,g(r,t)),e),{});function f(e){return void 0===e}function h(e){var r=typeof e;return null!=e&&("object"===r||"function"===r)}function l(e){return"string"==typeof e||e instanceof String}function d(e){return"function"==typeof e}function y(e){if(Promise&&Promise.resolve)return Promise.resolve(e)==e;throw"Promise not supported in your environment"}function g(e,r){for(var t=(r=(r=r.replace(/\[(\w+)\]/g,".$1")).replace(/^\./,"")).split("."),n=0,o=t.length;n<o;++n){var i=t[n];if(!(h(e)&&i in e))return;e=e[i]}return e}function m(e,r){return e.reduce((e,t,i)=>(function(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?n(t,!0).forEach(function(r){o(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):n(t).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e})({},e,{[t]:r[i]}),{})}function v(e,r){return"number"==typeof r&&Array.isArray(e)||function(e,r){return null!=e&&Object.prototype.hasOwnProperty.call(e,r)}(e,r)}function b(e,r,t,n){if("number"==typeof r&&(r=[r]),!r||0===r.length)return e;if("string"==typeof r)return b(e,r.split(".").map(P),t,n);var o=r[0],i=function(e,r){if(v(e,r))return e[r]}(e,o);return 1===r.length?(void 0!==i&&n||(e[o]=t),i):(void 0===i&&("number"==typeof r[1]?e[o]=[]:e[o]={}),b(e[o],r.slice(1),t,n))}function P(e){var r=parseInt(e);return r.toString()===e?r:e}function O(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,n)}return t}function j(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?O(t,!0).forEach(function(r){w(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):O(t).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}function w(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function S(e,r){return r&&!function(e){for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r))return!1;return!0}(r)&&(e[i]=r),e}!function(e){e.Root="Root",e.Property="Property",e.ActionFunction="ActionFunction",e.ActionAggregator="ActionAggregator",e.ActionString="ActionString",e.ActionSelector="ActionSelector"}(s||(s={}));class A{constructor(e){this.schemaOptions=void 0,this.root=void 0,this.schema=void 0,this.schema=e,this.schemaOptions=A.getSchemaOptions(this.schema),this.root={data:{targetPropertyPath:"",propertyName:"MorphismTreeRoot",action:null,kind:s.Root},parent:null,children:[]},e&&this.parseSchema(e)}static getSchemaOptions(e){return j({},{class:{automapping:!0},undefinedValues:{strip:!1}},{},e?e[i]:void 0)}parseSchema(e,r,t){var n;(l(n=e)||d(n)||a(n)||u(n))&&r?(this.add({propertyName:r,action:e},t),t=t?"".concat(t,".").concat(r):r):(r&&(this.add({propertyName:r,action:null},t),t=t?"".concat(t,".").concat(r):r),Array.isArray(e)?e.forEach((e,r)=>{this.parseSchema(e,r.toString(),t)}):h(e)&&Object.keys(e).forEach(r=>{this.parseSchema(e[r],r,t)}))}*traverseBFS(){var e=[];for(e.push(this.root);e.length>0;){var r=e.shift();if(!r)return;for(var t=0,n=r.children.length;t<n;t++)e.push(r.children[t]);r.data.kind!==s.Root&&(yield r)}}add(e,r){var t=this.getActionKind(e.action);if(!t)throw new Error("The action specified for ".concat(e.propertyName," is not supported."));var n={data:j({},e,{kind:t,targetPropertyPath:""}),parent:null,children:[]};if(n.data.preparedAction=this.getPreparedAction(n.data),r)for(var o of this.traverseBFS())o.data.targetPropertyPath===r&&(n.parent=o,n.data.targetPropertyPath="".concat(o.data.targetPropertyPath,".").concat(n.data.propertyName),o.children.push(n));else n.parent=this.root,n.data.targetPropertyPath=n.data.propertyName,this.root.children.push(n)}getActionKind(e){return c(e)?s.ActionString:d(e)?s.ActionFunction:a(e)?s.ActionSelector:u(e)?s.ActionAggregator:null===e?s.Property:void 0}getPreparedAction(e){var{propertyName:r,action:t,kind:n}=e;if(c(t))return e=>{var{object:r}=e;return g(r,t)};if(d(t))return e=>{var{object:r,items:n,objectToCompute:o}=e;return t.call(void 0,r,n,o)};if(u(t))return e=>{var{object:r}=e;return p(t,r)};if(a(t))return e=>{var n,{object:o,items:i,objectToCompute:a}=e;try{var c;Array.isArray(t.path)?c=p(t.path,o):l(t.path)&&(c=g(o,t.path)),n=t.fn.call(void 0,c,o,i,a)}catch(e){throw e.message="Unable to set target property [".concat(r,"].\n                                        \n An error occured when applying [").concat(t.fn.name,"] on property [").concat(t.path,"]\n                                        \n Internal error: ").concat(e.message),e}return n};if(n===s.Property)return null;throw new Error("The action specified for ".concat(r," is not supported."))}}function M(e){return(r,t,n)=>{var o=n.value;return"function"==typeof o&&(n.value=function(){for(var r=arguments.length,t=new Array(r),n=0;n<r;n++)t[n]=arguments[n];var i=o.apply(this,t);return y(i)?Promise.resolve(i).then(r=>e(r)):e(i)}),n}}function _(e,r,t,n){var o=r.schemaOptions,i=[];for(var a of r.traverseBFS()){var{preparedAction:c,targetPropertyPath:u}=a.data;c&&i.push({targetPropertyPath:u,preparedAction:c({object:e,objectToCompute:n,items:t})})}return i.reduce((e,r)=>{var t=((e,r)=>f(r)?f(e)?void 0:e:r)(g(e,r.targetPropertyPath),r.preparedAction);return void 0===t?(o&&o.undefinedValues&&o.undefinedValues.strip?o.undefinedValues.default&&b(e,r.targetPropertyPath,o.undefinedValues.default(e,r.targetPropertyPath)):b(e,r.targetPropertyPath,t),e):(b(e,r.targetPropertyPath,t),e)},n)}function E(e,r){var t,n=A.getSchemaOptions(e);if(r&&n.class&&n.class.automapping){var o=function(e,r){var t=Object.keys(new e),n=m(t,t);return Object.assign(n,r)}(r,e);t=new A(o)}else t=new A(e);return e=>{if(!e)return e;if(Array.isArray(e))return e.map(n=>{if(r){var o=new r;return _(n,t,e,o)}return _(n,t,e,{})});var n=e;if(r){var o=new r;return _(n,t,[n],o)}return _(n,t,[n],{})}}function x(e,r,t){switch(arguments.length){case 1:return E(e);case 2:return E(e)(r);case 3:if(t)return null!==r?E(e,t)(r):E(e,t);throw new Error("When using morphism(schema, items, type), type should be defined but value received is ".concat(t))}}function T(e,r){return M(E(e,r))}function k(e){return M(E(e))}function D(e,r){return M(E(e,r))}t.d(r,"morph",function(){return T}),t.d(r,"toJSObject",function(){return k}),t.d(r,"toClassObject",function(){return D}),t.d(r,"morphism",function(){return x}),t.d(r,"createSchema",function(){return S}),t.d(r,"Schema",function(){}),t.d(r,"StrictSchema",function(){}),t.d(r,"SchemaOptions",function(){}),t.d(r,"Mapper",function(){}),t.d(r,"SCHEMA_OPTIONS_SYMBOL",function(){return i});var N=new class{constructor(e){this._registry=null,this._registry=e||{cache:new Map}}register(e,r){if(!e&&!r)throw new Error("type paramater is required when you register a mapping");if(this.exists(e))throw new Error("A mapper for ".concat(e.name," has already been registered"));var t;return t=x(r||{},null,e),this._registry.cache.set(e,t),t}map(e,r){if(!this.exists(e)){var t=this.register(e);if(void 0===r)return t}return this.getMapper(e)(r)}getMapper(e){return this._registry.cache.get(e)}setMapper(e,r){if(r){if(this.exists(e)){var t=x(r,null,e);return this._registry.cache.set(e,t),t}throw new Error("The type ".concat(e.name," is not registered. Register it using `Mophism.register(").concat(e.name,", schema)`"))}throw new Error("The schema must be an Object. Found ".concat(r))}deleteMapper(e){return this._registry.cache.delete(e)}exists(e){return this._registry.cache.has(e)}get mappers(){return this._registry.cache}},F=x;F.register=(e,r)=>N.register(e,r),F.map=(e,r)=>N.map(e,r),F.getMapper=e=>N.getMapper(e),F.setMapper=(e,r)=>N.setMapper(e,r),F.deleteMapper=e=>N.deleteMapper(e),F.mappers=N.mappers;var R=F;r.default=R}])});
//# sourceMappingURL=morphism.map